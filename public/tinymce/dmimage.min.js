tinymce.PluginManager.add('dmimage', function(editor, url) {
  var imgdata = '';
  var openDialog = function () {
    return editor.windowManager.openUrl({
      title: 'Insert image',
      url: '/tinymce/select/image',
      buttons: [
        {type:'custom',
         text: 'confirm',
         primary: true
        },
        {type:'cancel',
         text: 'Cancel'
        }
      ],      
      onMessage: function (api, details) {        
        imgdata = details.data;
      },
      onAction: function(api, details){
        var width = imgdata.width;
        var height = imgdata.height;
        var image = imgdata.image
        var dmdata = image.content_type + ';' + image.cid+';'+ image.cuid;
        editor.insertContent( "<img data-dm-content='"+ dmdata +"' "+ (width?"width='"+width+"' ":"") + (height?"height='"+height+"'":"") +" src='http://localhost:3000/var/"+imgdata.image.image+"'>");
        api.close();
      }
    });
  };
  /* Add a button that opens a window */
  editor.ui.registry.addButton('dmimage', {
    text: 'dmimage',
    onAction: function () {
      /* Open window */
      openDialog();
    }
  });
  /* Adds a menu item, which can then be included in any menu via the menu/menubar configuration */
  editor.ui.registry.addMenuItem('dmimage', {
    text: 'Image',
    onAction: function() {
      openDialog();
    }
  });
  /* Return the metadata for the help plugin */
  return {
    getMetadata: function () {
      return  {
        name: 'dmimage',
        url: 'http://digimaker.org'
      };
    }
  };
});